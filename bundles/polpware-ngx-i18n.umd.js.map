{"version":3,"file":"polpware-ngx-i18n.umd.js.map","sources":["ng://@polpware/ngx-i18n/lib/services/resource-loader.service.ts"],"sourcesContent":["import { Injectable, NgZone } from '@angular/core';\r\n\r\nimport * as externalInterface from '@polpware/fe-dependencies';\r\nimport { replace } from '@polpware/fe-utilities';\r\n\r\nimport { loadJsonUriP } from '@polpware/fe-data';\r\nimport { I18n } from '@polpware/fe-data';\r\nimport { ResourceLoader } from '@polpware/fe-data';\r\n\r\nimport {\r\n    ISlidingExpireCache\r\n} from '@polpware/fe-data';\r\nimport {\r\n    SlidingExpirationCache\r\n} from '@polpware/fe-data';\r\n\r\nconst _ = externalInterface.underscore;\r\n\r\ninterface ILangOptionEntry {\r\n    code: string;\r\n    text: string;\r\n}\r\n\r\n/**\r\n * Verify if the given lang is valid. If the given lang is not valid,\r\n * this function returns a default one.\r\n * @private\r\n * @function validate\r\n * @param {Object} options The avaliable lang options.\r\n * @param {String} lang The requested lang code.\r\n * @returns {String} Verified lang code.\r\n */\r\nfunction validate(options: Array<ILangOptionEntry>, code: string) {\r\n    let lang = code || 'en-us';\r\n    const entry = _.find(options, e => e.code.substring(0, 2) === lang.substring(0, 2));\r\n    if (entry) {\r\n        lang = entry.code;\r\n    }\r\n\r\n    return lang;\r\n}\r\n\r\n\r\n@Injectable()\r\nexport class ResourceLoaderService {\r\n\r\n    private _resourceLoader: ResourceLoader;\r\n\r\n    constructor(ngZone: NgZone) {\r\n        const cache = new SlidingExpirationCache<any>(3 * 60, 5 * 60, ngZone);\r\n        this._resourceLoader = new ResourceLoader(cache);\r\n    }\r\n\r\n    public get resourceLoader() {\r\n        return this._resourceLoader;\r\n    }\r\n\r\n    /**\r\n     * Loads the dictionary for the given lang code.\r\n     * @function loadPromise\r\n     * @param {String} langCode The requested language code.\r\n     * @param {String}[] filter The optional language code which we are not interested in.\r\n     * @returns {Promise} The promise with the state of the loaded language dictionary.\r\n     * @throws {Error}\r\n     */\r\n    loadPromise(langCode: string, filter: string) {\r\n        const resourceLoader = this._resourceLoader;\r\n        return resourceLoader.getPromise<string>('lang.options', id => id)\r\n            .then(function(resolvedOptionsUrl) {\r\n                return loadJsonUriP(resolvedOptionsUrl);\r\n            })\r\n            .then(function(resolvedOptions) {\r\n                return validate(resolvedOptions, langCode);\r\n            })\r\n            .then(function(resolvedLangCode) {\r\n                if (resolvedLangCode === filter) {\r\n                    throw new Error('Loading the current language: ' + resolvedLangCode);\r\n                }\r\n                return resolvedLangCode;\r\n            })\r\n            .then(function(filteredLangCode) {\r\n                langCode = filteredLangCode;\r\n                return resourceLoader.getPromise<string>('lang.urlTmpl', id => id);\r\n            })\r\n            .then(function(resolvedUrlTmpl) {\r\n                return replace(resolvedUrlTmpl, { code: langCode });\r\n            })\r\n            .then(function(resolvedUrl) {\r\n                return loadJsonUriP(resolvedUrl);\r\n            })\r\n            .then(function(resolvedData) {\r\n                I18n.add(resolvedData.code, resolvedData.items);\r\n                I18n.recycleOthers(resolvedData.code);\r\n                return resolvedData;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Load lang options\r\n     * @function loadOptionPromise\r\n     * @returns {Promise}\r\n     */\r\n    loadOptionPromise() {\r\n        return this._resourceLoader.getPromise('lang.options', id => id)\r\n            .then(function(resolvedOptionsUrl) {\r\n                return loadJsonUriP(resolvedOptionsUrl);\r\n            });\r\n    }\r\n}\r\n"],"names":["externalInterface.underscore","SlidingExpirationCache","ResourceLoader","loadJsonUriP","replace","I18n","Injectable","NgZone"],"mappings":";;;;;;;;;;AAAA;QAgBM,CAAC,GAAGA,4BAA4B;;;;;;;;IAgBtC,SAAS,QAAQ,CAAC,OAAgC,EAAE,IAAY;;YACxD,IAAI,GAAG,IAAI,IAAI,OAAO;;YACpB,KAAK,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,GAAA,CAAC;QACnF,IAAI,KAAK,EAAE;YACP,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC;SACrB;QAED,OAAO,IAAI,CAAC;IAChB,CAAC;AAGD;QAKI,+BAAY,MAAc;;gBAChB,KAAK,GAAG,IAAIC,6BAAsB,CAAM,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,EAAE,EAAE,MAAM,CAAC;YACrE,IAAI,CAAC,eAAe,GAAG,IAAIC,qBAAc,CAAC,KAAK,CAAC,CAAC;SACpD;QAED,sBAAW,iDAAc;;;gBAAzB;gBACI,OAAO,IAAI,CAAC,eAAe,CAAC;aAC/B;;;WAAA;;;;;;;;;;;;;;;;QAUD,2CAAW;;;;;;;YAAX,UAAY,QAAgB,EAAE,MAAc;;oBAClC,cAAc,GAAG,IAAI,CAAC,eAAe;gBAC3C,OAAO,cAAc,CAAC,UAAU,CAAS,cAAc,EAAE,UAAA,EAAE,IAAI,OAAA,EAAE,GAAA,CAAC;qBAC7D,IAAI,CAAC,UAAS,kBAAkB;oBAC7B,OAAOC,mBAAY,CAAC,kBAAkB,CAAC,CAAC;iBAC3C,CAAC;qBACD,IAAI,CAAC,UAAS,eAAe;oBAC1B,OAAO,QAAQ,CAAC,eAAe,EAAE,QAAQ,CAAC,CAAC;iBAC9C,CAAC;qBACD,IAAI,CAAC,UAAS,gBAAgB;oBAC3B,IAAI,gBAAgB,KAAK,MAAM,EAAE;wBAC7B,MAAM,IAAI,KAAK,CAAC,gCAAgC,GAAG,gBAAgB,CAAC,CAAC;qBACxE;oBACD,OAAO,gBAAgB,CAAC;iBAC3B,CAAC;qBACD,IAAI,CAAC,UAAS,gBAAgB;oBAC3B,QAAQ,GAAG,gBAAgB,CAAC;oBAC5B,OAAO,cAAc,CAAC,UAAU,CAAS,cAAc,EAAE,UAAA,EAAE,IAAI,OAAA,EAAE,GAAA,CAAC,CAAC;iBACtE,CAAC;qBACD,IAAI,CAAC,UAAS,eAAe;oBAC1B,OAAOC,mBAAO,CAAC,eAAe,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC,CAAC;iBACvD,CAAC;qBACD,IAAI,CAAC,UAAS,WAAW;oBACtB,OAAOD,mBAAY,CAAC,WAAW,CAAC,CAAC;iBACpC,CAAC;qBACD,IAAI,CAAC,UAAS,YAAY;oBACvBE,WAAI,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,EAAE,YAAY,CAAC,KAAK,CAAC,CAAC;oBAChDA,WAAI,CAAC,aAAa,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;oBACtC,OAAO,YAAY,CAAC;iBACvB,CAAC,CAAC;aACV;;;;;;;;;;QAOD,iDAAiB;;;;YAAjB;gBACI,OAAO,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,cAAc,EAAE,UAAA,EAAE,IAAI,OAAA,EAAE,GAAA,CAAC;qBAC3D,IAAI,CAAC,UAAS,kBAAkB;oBAC7B,OAAOF,mBAAY,CAAC,kBAAkB,CAAC,CAAC;iBAC3C,CAAC,CAAC;aACV;;oBAhEJG,eAAU;;;;;wBA3CUC,WAAM;;;QA4G3B,4BAAC;KAjED;;;;;;;;;;;;;;;;;;;;;;"}
